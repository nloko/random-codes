<!DOCTYPE html>
<html>
  <head>
    <script type='text/javascript'>
	var CELL_SIZE = 8;
	var GRID_SIZE = 600 / CELL_SIZE;
	var grid  = new Array(GRID_SIZE);
        var gen   = new Array(GRID_SIZE);
	var intervalID = 0;

	// Pattern reference: http://www.conwaylife.com/patterns/gosperglidergun.cells
	//
	var gosper = ["........................O", 
			"......................O.O", 
			"............OO......OO............OO", 
			"...........O...O....OO............OO", 
			"OO........O.....O...OO", 
			"OO........O...O.OO....O.O", 
			"..........O.....O.......O", 
			"...........O...O", 
			"............OO"];

	function fillGeneration() {
	  for (var i = 0; i < grid.length; i++) {
            for (var j = 0; j < grid[i].length; j++) {
	      gen[i][j] = grid[i][j];
	    }
	  }
	}

	function init() {
	  for (var i = 0; i < grid.length; i++) {
	    grid[i] = new Array(GRID_SIZE);
	    gen[i]  = new Array(GRID_SIZE);
            for (var j = 0; j < grid[i].length; j++) {
	      grid[i][j] = gen[i][j] = 0;
	    }
	  }
	}

	function seedPattern(p) {
	  init();

	  for (var i = 0; i < p.length; i++) {
	    for (var j = 0; j < p[i].length; j++) {
	      var c = p[i].charAt(j);
	      if (c == 'O') grid[j][i] = 1;
	    }
	  }
	}

	function randomSeed(n) {
	  init();

	  for (var i = 0; i < n; i++) {
	    var x = Math.floor(Math.random() * GRID_SIZE);
	    var y = Math.floor(Math.random() * GRID_SIZE);
	    grid[x][y] = 1;
	  } 
        }

	function neighbours(gen, i, j) {
	  var minX = Math.max(i - 1, 0);
	  var minY = Math.max(j - 1, 0);
	  var maxX = Math.min(i + 1, grid.length - 1);
	  var maxY = Math.min(j + 1, grid.length - 1);

	  var score = 0;

	  for (var x = minX; x <= maxX; x++) {
	    for (var y = minY; y <= maxY; y++) {
	      if (x == i && y == j) continue;
	      if (gen[x][y]) score++;
	    }
	  }

	  return score;
	}

 	function tick() {
	  fillGeneration();
	  for (var i = 0; i < gen.length; i++) {
	    for (var j = 0; j < gen[i].length; j++) { 
	      var score = neighbours(gen, i, j);
	      if (gen[i][j]) {
	        if (score < 2) grid[i][j] = 0;
	        else if (score > 3) grid[i][j] = 0;
	      } else if (score == 3) grid[i][j] = 1;
	    }
	  }
	}

	function drawGrid() {
          var canvas = document.getElementById('grid');
          var ctx = canvas.getContext('2d');

          ctx.strokeStyle = '#dddddd';
	  ctx.lineCap = 'square';

	  for (var i = 0; i <= grid.length; i++) {
	    var offset = i * CELL_SIZE + 0.5;
	    ctx.beginPath();
            ctx.moveTo(offset, 0.5);
            ctx.lineTo(offset, canvas.height);
            ctx.stroke();	
	  
	    ctx.beginPath();
            ctx.moveTo(0.5, offset);
            ctx.lineTo(canvas.width, offset);
            ctx.stroke();	
	  }  
	}

	function draw() {
          var canvas = document.getElementById('cells');
          var ctx = canvas.getContext('2d');
	  ctx.fillStyle = '#000000';

	  for (var i = 0; i < grid.length; i++) {
	    for ( var j = 0; j < grid[i].length; j++) {
	      if (!grid[i][j]) {
                ctx.clearRect(i * CELL_SIZE, j * CELL_SIZE, CELL_SIZE, CELL_SIZE);
	      } else {
	        ctx.fillRect(i * CELL_SIZE, j * CELL_SIZE, CELL_SIZE, CELL_SIZE);
              }
            }
	  }
	}
 
	function gospersGun() {
	  play(function() {
	    seedPattern(gosper);
	  });
	}

	function random() {
	  play(function() {
	    // create too many and majority will die off due to
	    // overcrowding
	    //
	    randomSeed(GRID_SIZE * GRID_SIZE * 0.4);
	  });
	}

	function attachEventHandlers() {
	    attachEventHandlers.x = 0.5;
	    attachEventHandlers.y = 0.5;

	    var canvas = document.getElementById('grid');
	    var ctx = canvas.getContext('2d');

	    canvas.addEventListener('mousemove', function(ev) {
		var x = ev.layerX;
    		var y = ev.layerY;

		ctx.fillStyle = '#ffffff';
		ctx.clearRect(attachEventHandlers.x, attachEventHandlers.y, CELL_SIZE, CELL_SIZE);
		ctx.strokeRect(attachEventHandlers.x, attachEventHandlers.y, CELL_SIZE, CELL_SIZE);
		
		ctx.fillStyle = 'rgba(0, 0, 255, 0.5)';
		ctx.fillRect(x = Math.floor(x / CELL_SIZE) * CELL_SIZE, 
			y = Math.floor(y / CELL_SIZE) * CELL_SIZE, 
			CELL_SIZE, 
			CELL_SIZE);

	   	attachEventHandlers.x = x + 0.5;
		attachEventHandlers.y = y + 0.5;	
	    }, false);

	    canvas.addEventListener('mouseup', function(ev) {
		var x = (attachEventHandlers.x - 0.5) / CELL_SIZE;
		var y = (attachEventHandlers.y - 0.5) / CELL_SIZE;
		grid[x][y] = 1;
	    }, false);

	    canvas.addEventListener('mouseout', function(ev) {
	    	ctx.fillStyle = '#ffffff';
		ctx.clearRect(attachEventHandlers.x, attachEventHandlers.y, CELL_SIZE, CELL_SIZE);
		ctx.strokeRect(attachEventHandlers.x, attachEventHandlers.y, CELL_SIZE, CELL_SIZE);
	    }, false);		
	}

        function play(seed) {
	  if (intervalID) clearInterval(intervalID);
	 
          drawGrid(); 
	  seed();
          draw();
	  attachEventHandlers();

	  intervalID = setInterval(function() {
	    tick();
            draw();
          }, 150);
  	}
    </script>
    <style type='text/css'>
       body {
	 font-family: 'Arial', 'sans-serif';
	 text-align: center;
       }

       h1 {
	margin: 2px;
       }

       canvas {
	 display: block;
	 margin-right: auto;
	 margin-left: -50%;
	 left: 50%;
       }

       #container {
	 height: 600px;
         width: 600px;
	 position: relative;
	 margin: 0 auto;
	 margin-bottom: 20px;
       }

       #grid {
	 position: absolute;
 	 z-index: 1;
       }

       #cells {
         position: absolute;
         z-index: 0;
       }

       .menu {
	 margin: 10px;
       }

       a.action {
	 color: #000;
	 text-decoration: none;
       }

       a.action:hover {
         text-decoration: underline;
       }
    </style>
  </head>
  <body onload='random();'>
    <h1>Conway's Game of Life</h1>
    <div class='menu'>
      <a class='action' href="http://en.wikipedia.org/wiki/Conway's_Game_of_Life" target="_blank">Huh?</a> |
      <a class='action' href="javascript:void(0)" onclick='random();'>Randomize</a> |
      <a class='action' href="javascript:void(0)" onclick='gospersGun();'>Gosper's Gun</a>
    </div>
    <div id='container'>
      <canvas id="cells" width="600px" height="600px"></canvas>
      <canvas id="grid" width="601px" height="601px">
	<p>Your browser does not support HTML5 &lt;canvas&gt;</p>	
      </canvas>
    </div>
  </body>
</html>
